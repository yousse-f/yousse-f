name: Auto Commit and Green Dots

on:
  schedule:
    # 3 commit automatici al giorno per bollini verdi intensi! ğŸŸ¢
    - cron: '0 8 * * *'   # 08:00 UTC (10:00 Italia) - Morning commit
    - cron: '0 11 * * *'  # 11:00 UTC (13:00 Italia) - Lunch commit  
    - cron: '0 15 * * *'  # 15:00 UTC (17:00 Italia) - Afternoon commit
  workflow_dispatch:  # Permette esecuzione manuale
  push:
    branches: [ main, master ]
    paths-ignore:
      - '.github/**'

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Create or Update Activity Log
      run: |
        # Crea cartella logs se non esiste
        mkdir -p logs
        
        # Determina il tipo di commit in base all'ora
        HOUR=$(date +%H)
        if [ "$HOUR" -eq "8" ]; then
          COMMIT_TYPE="ğŸŒ… Morning"
          ACTIVITY_MSG="Morning activity boost"
        elif [ "$HOUR" -eq "11" ]; then
          COMMIT_TYPE="â˜€ï¸ Midday"
          ACTIVITY_MSG="Midday productivity peak"
        elif [ "$HOUR" -eq "15" ]; then
          COMMIT_TYPE="ğŸŒ† Afternoon"
          ACTIVITY_MSG="Afternoon development session"
        else
          COMMIT_TYPE="ğŸ¤– Auto"
          ACTIVITY_MSG="Automated activity update"
        fi
        
        # Aggiorna il log delle attivitÃ 
        echo "$(date): $ACTIVITY_MSG - Keeping the GitHub streak alive! ğŸš€" >> logs/activity.log
        
        # Aggiorna il README con timestamp dell'ultimo aggiornamento
        if grep -q "Last updated:" README.md; then
          sed -i "s/Last updated:.*/Last updated: $(date '+%B %d, %Y at %H:%M UTC') - $COMMIT_TYPE/" README.md
        else
          echo "" >> README.md
          echo "---" >> README.md
          echo "*Last updated: $(date '+%B %d, %Y at %H:%M UTC') - $COMMIT_TYPE*" >> README.md
        fi

    - name: Commit Changes
      run: |
        # Determina il tipo di commit in base all'ora
        HOUR=$(date +%H)
        if [ "$HOUR" -eq "8" ]; then
          COMMIT_MSG="ğŸŒ… Morning boost: $(date '+%Y-%m-%d %H:%M')"
        elif [ "$HOUR" -eq "11" ]; then
          COMMIT_MSG="â˜€ï¸ Midday update: $(date '+%Y-%m-%d %H:%M')"
        elif [ "$HOUR" -eq "15" ]; then
          COMMIT_MSG="ğŸŒ† Afternoon session: $(date '+%Y-%m-%d %H:%M')"
        else
          COMMIT_MSG="ğŸ¤– Auto-update: $(date '+%Y-%m-%d %H:%M')"
        fi
        
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "$COMMIT_MSG"
          git push origin main || git push origin master
        fi

    - name: Create Daily Commit (Fallback)
      run: |
        # Se non ci sono modifiche, crea comunque un piccolo commit
        HOUR=$(date +%H)
        if [ "$HOUR" -eq "8" ]; then
          MARKER_MSG="ğŸŒ… Morning activity marker"
        elif [ "$HOUR" -eq "11" ]; then
          MARKER_MSG="â˜€ï¸ Midday activity marker"
        elif [ "$HOUR" -eq "15" ]; then
          MARKER_MSG="ğŸŒ† Afternoon activity marker"
        else
          MARKER_MSG="ğŸ“… Daily activity marker"
        fi
        
        echo "$MARKER_MSG: $(date)" > .github/daily-marker-$(date +%H).txt
        git add .github/daily-marker-$(date +%H).txt
        git commit -m "$MARKER_MSG - $(date '+%Y-%m-%d')" || true
        git push origin main || git push origin master || true
